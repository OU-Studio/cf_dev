<product-info
  id="MainProduct-{{ section.id }}"
  class="section-{{ section.id }}-padding gradient color-{{ section.settings.color_scheme }}"
  data-section="{{ section.id }}"
  data-product-id="{{ product.id }}"
  data-update-url="true"
  data-url="{{ product.url }}"
>
  {{ 'component-price.css' | asset_url | stylesheet_tag }}

  {%- style -%}
    .section-{{ section.id }}-padding{padding-top:{{ section.settings.padding_top | times: 0.75 | round: 0 }}px;padding-bottom:{{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px}
    @media (min-width:750px){.section-{{ section.id }}-padding{padding-top:{{ section.settings.padding_top }}px;padding-bottom:{{ section.settings.padding_bottom }}px}}
    .cf-product{max-width:var(--page-width, {{ settings.page_width | default: 1200 }}px);margin:0 auto}

    .cf-breadcrumbs a{text-decoration:none}
    .cf-grid{display:grid;gap:40px}
    @media (min-width: 990px){.cf-grid{grid-template-columns: 40% 1fr}}
    .cf-left{position:relative}
    .cf-right{display:flex;flex-direction:column;gap:4px}
    .cf-price{display:block}
    .cf-form-row{display:flex;gap:12px;align-items:center}
    .cf-qty{display:inline-flex;align-items:center;border:1px solid var(--color-border, #e5e5e5)}
    .cf-qty input{width:64px;text-align:center;border:0;padding:.5rem}
    .cf-qty button{appearance:none;border:0;background:transparent;cursor:pointer;padding:.5rem;line-height:1}
    .cf-atc{min-width:220px}
    .cf-hr{border:0;border-top:1px solid var(--color-border, #e5e5e5);margin:8px 0 4px}
    .cf-rows{display:flex;flex-direction:column;gap:30px}
    .cf-row{display:grid;grid-template-columns:60px 1fr;gap:30px;align-items:start}
    .cf-row h3{margin:0 0 4px 0;font-size:1rem}
    .cf-row p{margin:0}
    .cf-ph{width:60px;height:60px;display:flex;align-items:center;justify-content:center;}
    /* Slick basic sizing */
    .cf-slider-for .slide{aspect-ratio: 1/1; display:flex;align-items:center;justify-content:center;background:#fafafa}
    .cf-slider-for img{max-width:100%;max-height:100%;object-fit:contain}
    .cf-slider-nav .thumb{padding:2px}
    .cf-slider-nav img{width:100%;height:100%;object-fit:cover}
    .cf-slider-nav .slick-slide{opacity:.6}
    .cf-slider-nav .slick-current{opacity:1}
  {%- endstyle -%}

  <script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'product-info.js' | asset_url }}" defer="defer"></script>
  {{ 'component-deferred-media.css' | asset_url | stylesheet_tag }}
  {{ 'component-rating.css' | asset_url | stylesheet_tag }}

  <div class="page-width cf-product product">
    <!-- Breadcrumbs -->
    <nav class="cf-breadcrumbs" aria-label="Breadcrumb">
      <a href="{{ routes.root_url }}">Home</a>
      {%- if collection -%}
        &nbsp;¬ª&nbsp;<a href="{{ collection.url }}">{{ collection.title }}</a>
      {%- endif -%}
      &nbsp;¬ª&nbsp;<span aria-current="page">{{ product.title }}</span>
    </nav>

    <!-- 2-col layout -->
    <div class="cf-grid">
      <!-- LEFT: Slick slideshow with thumbnails -->
      <div class="cf-left">
        <div class="cf-slider-for">
          {%- for image in product.images -%}
            <div class="slide">
              {{ image | image_url: width: 1920 | image_tag: loading: 'lazy', widths: '400, 800, 1200, 1600, 1920', alt: image.alt | escape }}
            </div>
          {%- endfor -%}
          {%- if product.images.size == 0 and product.featured_media -%}
            <div class="slide">
              {{ product.featured_media | image_url: width: 1920 | image_tag: loading: 'lazy', widths: '400, 800, 1200, 1600, 1920', alt: product.title | escape }}
            </div>
          {%- endif -%}
        </div>
        <div class="cf-slider-nav" aria-label="Thumbnails">
          {%- for image in product.images -%}
            <div class="thumb">
              {{ image | image_url: width: 220 | image_tag: loading: 'lazy', alt: image.alt | escape }}
            </div>
          {%- endfor -%}
        </div>
      </div>

      <!-- RIGHT: Title, Price, Size metafield, Description, Qty + ATC, HR, Info rows -->
      <div class="cf-right">
        <h1 class="cf-title">{{ product.title | escape }}</h1>

        <div class="cf-price" id="price-{{ section.id }}" role="status">
          {%- render 'price',
            product: product,
            use_variant: true,
            show_badges: false,
            price_class: 'price--large'
          -%}
        </div>

        {%- if product.metafields.custom.product_size != blank -%}
          <div class="cf-size">
            {{ product.metafields.custom.product_size }}
          </div>
        {%- endif -%}

        {%- if product.description != blank -%}
          <div class="cf-desc rte">
            {{ product.description }}
          </div>
        {%- endif -%}

        {%- assign product_form_id = 'product-form-' | append: section.id -%}
       {%- assign product_form_id = 'product-form-' | append: section.id -%}

<div class="cf-form-row">
  <product-form class="product-form" data-hide-errors="false">
    {%- form 'product', product, id: product_form_id, class: 'form' -%}

      {%- comment -%} --- VARIANT SELECTORS --- {%- endcomment -%}
      {%- if product.variants.size > 1 and product.has_only_default_variant == false -%}
        <div class="cf-options">
          {%- for option in product.options_with_values -%}
            <div class="cf-option">
              <label class="cf-option__label" for="Option-{{ section.id }}-{{ forloop.index0 }}">{{ option.name }}</label>
              <select
                id="Option-{{ section.id }}-{{ forloop.index0 }}"
                class="cf-option__select"
                name="options[{{ option.name | escape }}]"
              >
                {%- for value in option.values -%}
                  <option value="{{ value | escape }}" {% if option.selected_value == value %}selected{% endif %}>{{ value }}</option>
                {%- endfor -%}
              </select>
            </div>
          {%- endfor -%}
        </div>
      {%- endif -%}

      {%- comment -%} Hidden variant id that our JS updates {%- endcomment -%}
      <input
        type="hidden"
        name="id"
        value="{{ product.selected_or_first_available_variant.id }}"
        id="SelectedVariantId-{{ section.id }}"
      >

      {%- comment -%} Variant JSON for the sync script {%- endcomment -%}
      <script type="application/json" id="VariantData-{{ section.id }}">
        {{ product.variants | json }}
      </script>

      {%- comment -%} Quantity {%- endcomment -%}
      <quantity-input class="quantity"> <button class="quantity__button" name="minus" type="button"> <span class="visually-hidden"> {{- 'products.product.quantity.decrease' | t: product: product.title | escape -}} </span> <span class="svg-wrapper"> {{- 'icon-minus.svg' | inline_asset_content -}} </span> </button> <input class="quantity__input" type="number" name="quantity" id="Quantity-{{ section.id }}" data-cart-quantity="{{ cart_qty }}" data-min="{{ product.selected_or_first_available_variant.quantity_rule.min }}" min="{{ product.selected_or_first_available_variant.quantity_rule.min }}" {% if product.selected_or_first_available_variant.quantity_rule.max != null %} data-max="{{ product.selected_or_first_available_variant.quantity_rule.max }}" max="{{ product.selected_or_first_available_variant.quantity_rule.max }}" {% endif %} step="{{ product.selected_or_first_available_variant.quantity_rule.increment }}" value="{{ product.selected_or_first_available_variant.quantity_rule.min }}" form="{{ product_form_id }}" > <button class="quantity__button" name="plus" type="button"> <span class="visually-hidden"> {{- 'products.product.quantity.increase' | t: product: product.title | escape -}} </span> <span class="svg-wrapper"> {{- 'icon-plus.svg' | inline_asset_content -}} </span> </button> </quantity-input>

      {%- comment -%} Submit + dynamic checkout inside the SAME form {%- endcomment -%}
      <div class="product-form__buttons">
        <button type="submit" class="product-form__submit button  norwesterLarge ">
          <span>{{ 'products.product.add_to_cart' | t }}</span>
          <div class="loading__spinner hidden" aria-hidden="true"></div>
        </button>

        {{ form | payment_button }}
      </div>

    {%- endform -%}

    <div class="product-form__error-message-wrapper" role="alert" hidden>
      <span class="product-form__error-message"></span>
    </div>
  </product-form>
</div>

        <hr class="cf-hr">

        <div class="cf-rows">
          {%- if product.metafields.custom.fragranced_with != blank -%}
            <div class="cf-row fragrance">
              <div class="cf-ph" ></div>
              <div>
                <h3>Fragranced with</h3>
                <p>{{ product.metafields.custom.fragranced_with | newline_to_br }}</p>
              </div>
            </div>
          {%- endif -%}

          {%- if product.metafields.custom.superb_for != blank -%}
            <div class="cf-row superb">
              <div class="cf-ph" ></div>
              <div>
                <h3>Superb for</h3>
                <p>{{ product.metafields.custom.superb_for | newline_to_br }}</p>
              </div>
            </div>
          {%- endif -%}

          {%- if product.metafields.custom.benefits != blank -%}
            <div class="cf-row benefits">
              <div class="cf-ph" ></div>
              <div>
                <h3>Benefits</h3>
                <p>{{ product.metafields.custom.benefits | newline_to_br }}</p>
              </div>
            </div>
          {%- endif -%}
        </div>
      </div>
    </div>

    <!-- Structured data -->
    <script type="application/ld+json">
      {{ product | structured_data }}
    </script>
  </div>

  <!-- Load jQuery + Slick if needed, then init -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css">
  <script>
    (function(){
      function initSlick(){
        if (!window.jQuery || !jQuery.fn || !jQuery.fn.slick) return;

        var $for = jQuery('.cf-slider-for');
        var $nav = jQuery('.cf-slider-nav');

        if ($for.data('slick-initialized')) return;

        $for.on('init', function(){ $for.attr('data-slick-initialized', 'true'); });

        $for.slick({
          arrows: true,
          asNavFor: '.cf-slider-nav',
          adaptiveHeight: true,
          slidesToShow: 1,
          slidesToScroll: 1,
          infinite: false
        });

        $nav.slick({
          asNavFor: '.cf-slider-for',
          slidesToShow: Math.min(6, {{ product.images.size | default: 6 }}),
          slidesToScroll: 1,
          focusOnSelect: true,
          infinite: false,
          variableWidth: false
        });

        // Qty buttons
        document.querySelectorAll('.cf-qty').forEach(function(box){
          var input = box.querySelector('input[type="number"]');
          var minus = box.querySelector('.cf-qty-minus');
          var plus  = box.querySelector('.cf-qty-plus');
          function clamp(val){
            var min = parseInt(input.min || '1',10);
            var max = input.max ? parseInt(input.max,10) : null;
            val = Math.max(min, val);
            if (max) val = Math.min(max, val);
            return val;
          }
          minus.addEventListener('click', function(){
            var step = parseInt(input.step || '1',10);
            input.value = clamp(parseInt(input.value || '1',10) - step);
            input.dispatchEvent(new Event('change', {bubbles:true}));
          });
          plus.addEventListener('click', function(){
            var step = parseInt(input.step || '1',10);
            input.value = clamp(parseInt(input.value || '1',10) + step);
            input.dispatchEvent(new Event('change', {bubbles:true}));
          });
        });
      }

      function loadScript(src, cb){
        var s=document.createElement('script'); s.src=src; s.defer=true; s.onload=cb; document.head.appendChild(s);
      }

      function ensureSlick(){
        if (window.jQuery && jQuery.fn && jQuery.fn.slick){ initSlick(); return; }
        var afterJQ = function(){ loadScript('https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js', initSlick); };
        if (!window.jQuery){ loadScript('https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js', afterJQ); }
        else { afterJQ(); }
      }

      if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', ensureSlick); }
      else { ensureSlick(); }
    })();
  </script>
</product-info>

<script>
(() => {
  const sectionId = "{{ section.id }}";
  const variantJsonEl = document.getElementById("VariantData-" + sectionId);
  if (!variantJsonEl) return;

  const variants = JSON.parse(variantJsonEl.textContent || "[]");
  const selects = [
    document.getElementById(`Option-${sectionId}-0`),
    document.getElementById(`Option-${sectionId}-1`),
    document.getElementById(`Option-${sectionId}-2`)
  ].filter(Boolean);

  const hiddenInput = document.getElementById("SelectedVariantId-" + sectionId);
  const priceWrap = document.getElementById("price-" + sectionId);

  function findVariant(selected) {
    return variants.find(v =>
      selected[0] === v.option1 &&
      (selected[1] === undefined || selected[1] === v.option2) &&
      (selected[2] === undefined || selected[2] === v.option3)
    ) || null;
  }

  function formatMoney(cents) {
  const amount = (cents / 100).toLocaleString(undefined, {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
  return `{{ cart.currency.symbol }}${amount}`; // symbol first
}

  function updateUI(variant) {
    if (!variant) return;
    if (hiddenInput) hiddenInput.value = variant.id;

  // Add/remove body class for sold out
  document.body.classList.toggle('variant-soldout', !variant.available);

  const addBtn = document.querySelector('.product-form__submit');
const addBtnLabel = addBtn?.querySelector('span');

if (addBtnLabel) {
  addBtnLabel.textContent = variant.available
    ? "{{ 'products.product.add_to_cart' | t }}"
    : "{{ 'products.product.sold_out' | t }}";
}

    if (priceWrap) {
      const compare = variant.compare_at_price;
      const current = variant.price;
      priceWrap.innerHTML = `
        <div class="price price--large">
          ${compare && compare > current ? `<span class="price__compare"><s>${formatMoney(compare)}</s></span>` : ``}
          <span class="price__current">${formatMoney(current)}</span>
          ${!variant.available ? `<span class="price__badge">{{ 'products.product.sold_out' | t }}</span>` : ``}
        </div>
      `;
    }

    const url = new URL(location.href);
    url.searchParams.set("variant", variant.id);
    history.replaceState({}, "", url.toString());
  }

  function refreshDisabled() {
    if (selects.length < 2) return;
    const current = selects.map(s => s.value);
    selects.forEach((select, idx) => {
      const snapshot = current.slice();
      Array.from(select.options).forEach(opt => {
        snapshot[idx] = opt.value;
        const exists = variants.some(v =>
          snapshot[0] === v.option1 &&
          (snapshot[1] === undefined || snapshot[1] === v.option2) &&
          (snapshot[2] === undefined || snapshot[2] === v.option3) &&
          v.available
        );
        opt.disabled = !exists;
      });
    });
  }

  function onChange() {
    const selected = selects.map(s => s.value);
    const variant = findVariant(selected);
    updateUI(variant);
    refreshDisabled();
  }

  selects.forEach(s => s.addEventListener("change", onChange));
  onChange(); // initial
})();
</script>

<script>
(() => {
  const planeTpl = document.getElementById('paperplane');
  if (!planeTpl) return console.warn('‚ùå No #paperplane SVG found');

  const CART_ICON_SEL = 'a.header__action.header__action--cart';
  const ADD_BTN_SEL   = '.product-form__submit';
  const getCartIcon = () =>
    document.querySelector(CART_ICON_SEL) ||
    document.querySelector('#cart-icon-bubble') ||
    document.querySelector('[data-open-cart]') ||
    document.querySelector('.header__icon--cart') ||
    document.querySelector('a[href="/cart"]');

  let lastAddBtn = null;
  let lastClickAt = 0;
  let animTimeout = null;

  document.addEventListener('click', e => {
    const btn = e.target.closest(ADD_BTN_SEL);
    if (btn) { lastAddBtn = btn; lastClickAt = Date.now(); }
  });

  function centerOf(el){
    const r = el.getBoundingClientRect();
    return { x: r.left + r.width/2, y: r.top + r.height/2 };
  }

  function animatePlane(fromEl, toEl){
    if (!fromEl || !toEl) return;
    const start = centerOf(fromEl);
    const end   = centerOf(toEl);
    const mid   = { x:(start.x+end.x)/2, y: Math.min(start.y,end.y) + 100 };

    const clone = planeTpl.cloneNode(true);
    clone.removeAttribute('id');
    clone.classList.add('flying-plane');
    clone.style.left = '0';
    clone.style.top  = '0';
    clone.style.width = '32px';
    clone.style.height = '32px';
    clone.style.transform = `translate(${start.x}px,${start.y}px) scale(1) rotate(-10deg)`;
    clone.style.opacity = '1';
    document.body.appendChild(clone);

    const anim = clone.animate(
      [
        { transform:`translate(${start.x}px,${start.y}px) scale(1) rotate(-10deg)`, opacity:1 },
        { transform:`translate(${mid.x}px,${mid.y}px) scale(1) rotate(-5deg)`, opacity:.95, offset:.6 },
        { transform:`translate(${end.x}px,${end.y}px) scale(1) rotate(0deg)`, opacity:0 }
      ],
      { duration: 3500, easing: 'cubic-bezier(.25,.8,.25,1)', fill: 'forwards' }
    );

    anim.onfinish = () => {
      clone.remove();
      const cartIcon = getCartIcon();
      if (cartIcon) {
        cartIcon.classList.add('cart-bump');
        setTimeout(() => cartIcon.classList.remove('cart-bump'), 400);
      }
    };
  }

  function triggerIfRecent(){
    if (Date.now() - lastClickAt > 3000) return;
    if (animTimeout) return; // debounce multiple fires
    animTimeout = setTimeout(() => animTimeout = null, 500);

    const from = lastAddBtn || document.querySelector(ADD_BTN_SEL);
    const to = getCartIcon();
    if (to) requestAnimationFrame(() => animatePlane(from, to));
  }

  // Patch fetch only once
  if (!window.__planeFetchPatched) {
    const origFetch = window.fetch;
    window.fetch = async function(...args){
      const [input] = args;
      const url = typeof input === 'string' ? input : (input && input.url) || '';
      const isCartAdd = url.includes('/cart/add');
      const res = await origFetch.apply(this, args);
      if (isCartAdd) {
        const clone = res.clone();
        const data = await clone.json().catch(()=>null);
        const ok = res.ok && data && !data.status;
        if (ok) triggerIfRecent();
      }
      return res;
    };
    window.__planeFetchPatched = true;
    console.log('ü™ù fetch patched (debounced plane)');
  }
})();



</script>




{% schema %}
{
  "name": "Main product (CF custom)",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "range",
      "id": "padding_top",
      "min": 0, "max": 100, "step": 4, "unit": "px",
      "label": "Top padding", "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0, "max": 100, "step": 4, "unit": "px",
      "label": "Bottom padding", "default": 36
    }
  ],
  "blocks": []
}
{% endschema %}
